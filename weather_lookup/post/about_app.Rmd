---
title: "An app to look up your city's normal weather"
output: html_document
---

```{r setup, include=FALSE}
library(flair)
knitr::opts_chunk$set(echo = FALSE)

city_data_color <- "#984ea3"
data_color <- "#4daf4a"
temp_color <- "#ff7f00"
prcp_color <- "#377eb8"

city_data <- flair_all("city_data()", color = city_data_color, before = "<code>", after = "</code>")
```

<style>
.centered_img {
  text-align:center;
  margin: 0.25em;
}
.centered_img img {
  box-shadow: 1px 1px 6px black;
  margin: 0.1em;
}
</style>

## Summary


## Demo App

To demonstrate the benefits of caching we have built a shiny app that allows the user to look up the typical temperature range and precipitation amounts across a year. 


<div class = "centered_img"> 
<img src="full_app.png" width = 70%/> 

_Screenshot of the weather lookup app._
</div>



### NOAA Temperature Normals

The data driving the application comes from the [National Oceanic and Atmospheric Association (NOAA)](https://www.noaa.gov/). In the NOAA's open data portal they have a set of data for ["climate normals."](https://www.ncdc.noaa.gov/data-access/land-based-station-data/land-based-datasets/climate-normals) These data provide the "normal" or typical values of various climate measures for ~9.7 thousand weather stations around the US based on readings from 1981 to 2010. 

The way the data are stored place all the data for a given station within a text document located at an HTTP endpoint. For instance, the normals data for station <code><span style='color:forestgreen;'>USC00200228</span></code> located in Ann Arbor, MI is available at the endpoint 
[<code>https://www1.ncdc.noaa.gov/pub/data/normals/1981-2010/products/auxiliary/station/<span style='color:forestgreen;'>USC00200228</span>.normals.txt</code>](https://www1.ncdc.noaa.gov/pub/data/normals/1981-2010/products/auxiliary/station/USC00200228.normals.txt)


<div class = "centered_img"> 
<img src="station_data_example.png" width = 70%/> 

_Example of the first few lines of data for a station_
</div>





There are lots of interesting measures available in these "normals" but what our app focuses on is the temperature (daily minimum, average, maximum) and precipitation (monthly totals). If you want more info on these data take a look at the [NOAA landing page](https://www.ncdc.noaa.gov/data-access/land-based-station-data/land-based-datasets/climate-normals/1981-2010-normals-data) or [the scientific manuscript accompanying them.](https://journals.ametsoc.org/view/journals/bams/93/11/bams-d-11-00197.1.xml) 


### Inspiration for app

The goal for the app was to build a tool to quickly get a broad-level grasp of the weather in a given city. Questions such as "How hot does it get?" and "what's the wettest month?". An inspiration for the design came from the story ["How Much Warmer Was Your City in 2015?"](https://www.nytimes.com/interactive/2016/02/19/us/2015-year-in-weather-temperature-precipitation.html#new-york_ny) in the New York Times, by [K.K. Rebecca Lai.](https://www.nytimes.com/by/kk-rebecca-lai) 


<div class = "centered_img"> 
<a href = "https://www.nytimes.com/interactive/2016/02/19/us/2015-year-in-weather-temperature-precipitation.html">
<img src="nyt_inspiration.png" width = 70%/> 
</a>

[_New York Times article providing inspiration for app design._](https://www.nytimes.com/interactive/2016/02/19/us/2015-year-in-weather-temperature-precipitation.html)
</div>


### App flow

#### `r city_data` 
The state of the app centers around the currently selected city. When a city is selected, the app then reaches out to the NOAA servers and `r flair_all("downloads the data for every station", color = data_color)` residing in that city. From this data the `r flair_all("temperature", color = temp_color)` and `r flair_all("precipitation", color = prcp_color)` normals are extracted and averaged together to give an "averaged average" portrait of the city's weather. This parsed data is then stored in `reactive` value called `r city_data`...

```{r, echo = FALSE}
decorate('hefty-reactive') %>% 
  flair("city_data", color = city_data_color) %>% 
  flair("mutate(url = build_station_url(station),
               data = map(url, possibly(readr::read_file)))", color = data_color) %>% 
  flair("stations$temp_res <- map(stations$data, possibly(get_temp_data))", color = temp_color) %>% 
  flair("stations$prcp_res <- map(stations$data, possibly(get_prcp_data))", color = prcp_color)
```

```{r hefty-reactive, eval = FALSE}
server <- function(input, output, session) {
  ...
  city_data <- reactive({
    ...
    withProgress(message = 'Fetching data from NOAA', {
      stations <- filter(station_to_city, city == input$city)
      
      ...
      # Not every station has both temperature and precipitation data. To deal
      # with this, loop through all stations in a city try to extract whatever
      # data is present. If a city has a lot of stations, like Fairbanks, AK,
      # this this can take a while
      incProgress(1/4, detail = "Downloading data from all found stations")
      stations <- stations %>%
        mutate(url = build_station_url(station),
               data = map(url, possibly(readr::read_file)))
      # purrr::possibly allows bad requests to fail without crashing app 
      
      ...
      incProgress(2/4, detail = "Extracting temperature data")
      stations$temp_res <- map(stations$data, possibly(get_temp_data))
      temperature <- collapse_stations(stations$temp_res)

      ...
      incProgress(3/4, detail = "Extracting precipitation data")
      stations$prcp_res <- map(stations$data, possibly(get_prcp_data))
      precipitation <- collapse_stations(stations$prcp_res)

      ...
  })})
    
  ...
}
```

_See full code on [github](https://github.com/rstudio/shiny_showcase/blob/master/weather_lookup/app.R#L96-L133)_

This is a computationally intensive reactive value that does a lot of work. 

#### Plots

Two plots are generated using the data stored in `r city_data`. The first showing temperature and the second showing precipitation. These plots are themselves complex `ggplot2` objects, with many layers and annotations. Full ggplot code to generate each plot is available on github: [temperature,](https://github.com/rstudio/shiny_showcase/blob/master/weather_lookup/app.R#L149-L204) [precipitation](https://github.com/rstudio/shiny_showcase/blob/master/weather_lookup/app.R#L207-L252).


<div class = "centered_img"> 
<img src="temp_and_prcp_plots.png" width = 70%/> 

_Example output of plots generated by app_
</div>



#### Previous city button

A lot of times one may be interested in comparing the weather between two cities. This is made easier in the app by having a previous city button. This button simply sets the city to the city viewed just before the current city. This enables quick toggling back and forth between two cities to see the differences. 


<div class = "centered_img"> 
<img src="prev_city_button.png" width = 70%/> 
</div>



