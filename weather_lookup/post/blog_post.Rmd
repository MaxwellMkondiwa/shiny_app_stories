---
title: "Fast and kind API queries with `shiny::bindCache()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Summary

Here we demonstrate the use of the new `bindCache()` function in Shiny to greatly speedup a Shiny app that queries an NOAA weather station data API. The use of caching not only speeds up the app for end users but relieves pressure from the API. In this post we will demonstrate the adding of `bindCache` to existing reactive expressions, explaining where and why it should be used along with some potential gotchas of doing so. 

## Demo App

To demonstrate the benefits of caching we have built a shiny app that allows the user to look up the typical temperature range and precipitation amounts across a year. 

### NOAA Temperature Normals

The data driving the application comes from the [National Oceanic and Atmospheric Association (NOAA)](https://www.noaa.gov/). In the NOAA's open data portal they have a set of data for ["climate normals."](https://www.ncdc.noaa.gov/data-access/land-based-station-data/land-based-datasets/climate-normals) These data provide the "normal" or typical values of various climate measures for ~9.7 thousand weather stations around the US based on readings from 1981 to 2010. 

The way the data are stored place all the data for a given station within a text document located at an HTTP endpoint. For instance, the normals data for station <code><span style='color:forestgreen;'>USC00200228</span></code> located in Ann Arbor, MI is available at the endpoint 
[<code>https://www1.ncdc.noaa.gov/pub/data/normals/1981-2010/products/auxiliary/station/<span style='color:forestgreen;'>USC00200228</span>.normals.txt</code>](https://www1.ncdc.noaa.gov/pub/data/normals/1981-2010/products/auxiliary/station/USC00200228.normals.txt)


![](station_data_example.png)
_Example of the first few lines of data for a station_


There are lots of interesting measures available in these "normals" but what our app focuses on is the temperature (daily minimum, average, maximum) and precipitation (monthly totals). If you want more info on these data take a look at the [NOAA landing page](https://www.ncdc.noaa.gov/data-access/land-based-station-data/land-based-datasets/climate-normals/1981-2010-normals-data) or [the scientific manuscript accompanying them.](https://journals.ametsoc.org/view/journals/bams/93/11/bams-d-11-00197.1.xml) 


### Inspiration for app

The goal for the app was to build a tool to quickly get a broad-level grasp of the weather in a given city. Questions such as "How hot does it get?" and "what's the wettest month?". An inspiration for the design came from the story ["How Much Warmer Was Your City in 2015?"](https://www.nytimes.com/interactive/2016/02/19/us/2015-year-in-weather-temperature-precipitation.html#new-york_ny) in the New York Times, by [K.K. Rebecca Lai.](https://www.nytimes.com/by/kk-rebecca-lai) 

[![](nyt_inspiration.png)](https://www.nytimes.com/interactive/2016/02/19/us/2015-year-in-weather-temperature-precipitation.html)
_New York Times article providing inspiration for app design._



### App flow

- Current city
  - Downloads all stations within city's data
- Two semi-complicated plots for temperature and precipitation
- Previous city button for comparisons

## Performance with vanilla app
- Slow due to long process of gathering data for a city and potential slow server responses

## Adding Caching
- Just add `bindCache()` to all the complex reactives

## Performance with caching
- Biggest difference seen when toggling back and forth
  
## Tuning Caching
- Disk cache
- App cache
  - Will speed up app for future user's too
  - Common cities will be almost instant
- Cache size

## `bindCache()` vs `renderCachedPlot()`
- They're the same

